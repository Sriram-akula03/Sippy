<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="base" content="../" />
  <title>Sippy ‚Äî Checkout</title>
  <link rel="stylesheet" href="../css/global.css" />
  <link rel="stylesheet" href="../css/checkout.css" />
  <!-- Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <!-- EmailJS SDK loaded directly -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="../js/emailjs-init.js"></script>
  <script>
    if (typeof emailjs !== 'undefined') {
      emailjs.init(window.EMAILJS_PUBLIC_KEY);
    }
  </script>
</head>
<body>
<script>document.addEventListener('DOMContentLoaded',()=>injectNav(''));</script>

<!-- PAGE HEADER -->
<div class="checkout-hero">
  <div class="container">
    <div class="label" style="justify-content:center;">Secure Checkout</div>
    <h1>Almost There!</h1>
    <p>Fill in your details and pay securely via Razorpay</p>
  </div>
</div>

<section class="checkout-section">
  <div class="container">
    <div class="breadcrumb">
      <a href="../index.html">Home</a> ‚Ä∫ <a href="product.html">Product</a> ‚Ä∫ <span>Checkout</span>
    </div>

    <div class="checkout-grid">

      <!-- LEFT: FORM -->
      <div class="checkout-left" id="checkoutForm">

        <!-- CONTACT INFO -->
        <div class="checkout-block">
          <div class="cblock-head">
            <div class="cblock-num">1</div>
            <h3>Contact Information</h3>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" id="firstName" placeholder="Ravi" required />
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" id="lastName" placeholder="Kumar" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email Address *</label>
              <input type="email" id="email" placeholder="ravi@example.com" required />
            </div>
            <div class="form-group">
              <label>Mobile Number *</label>
              <input type="tel" id="phone" placeholder="+91 98765 43210" required />
            </div>
          </div>
        </div>

        <!-- SHIPPING ADDRESS -->
        <div class="checkout-block mt-24">
          <div class="cblock-head">
            <div class="cblock-num">2</div>
            <h3>Delivery Address</h3>
          </div>
          <div class="form-group">
            <label>House / Flat / Building *</label>
            <input type="text" id="address1" placeholder="Flat 4B, Sunshine Apartments" required />
          </div>
          <div class="form-group mt-16">
            <label>Street / Area / Locality *</label>
            <input type="text" id="address2" placeholder="Koramangala, 5th Block" required />
          </div>
          <div class="form-row mt-16">
            <div class="form-group">
              <label>City *</label>
              <input type="text" id="city" placeholder="Bengaluru" required />
            </div>
            <div class="form-group">
              <label>State *</label>
              <select id="state">
                <option value="">Select State</option>
                <option>Andhra Pradesh</option><option>Arunachal Pradesh</option>
                <option>Assam</option><option>Bihar</option><option>Chhattisgarh</option>
                <option>Goa</option><option>Gujarat</option><option>Haryana</option>
                <option>Himachal Pradesh</option><option>Jharkhand</option>
                <option>Karnataka</option><option>Kerala</option>
                <option>Madhya Pradesh</option><option>Maharashtra</option>
                <option>Manipur</option><option>Meghalaya</option><option>Mizoram</option>
                <option>Nagaland</option><option>Odisha</option><option>Punjab</option>
                <option>Rajasthan</option><option>Sikkim</option><option>Tamil Nadu</option>
                <option>Telangana</option><option>Tripura</option>
                <option>Uttar Pradesh</option><option>Uttarakhand</option>
                <option>West Bengal</option><option>Delhi</option>
              </select>
            </div>
          </div>
          <div class="form-row mt-16">
            <div class="form-group">
              <label>PIN Code *</label>
              <input type="text" id="pincode" placeholder="560034" maxlength="6" required />
            </div>
            <div class="form-group">
              <label>Landmark (optional)</label>
              <input type="text" id="landmark" placeholder="Near HDFC Bank" />
            </div>
          </div>
          <div class="form-group mt-16">
            <label>Order Notes (optional)</label>
            <textarea id="notes" rows="2" placeholder="Any special delivery instructions‚Ä¶"></textarea>
          </div>
        </div>

        <!-- PAYMENT METHOD -->
        <div class="checkout-block mt-24">
          <div class="cblock-head">
            <div class="cblock-num">3</div>
            <h3>Payment</h3>
          </div>
          <div class="payment-info">
            <div class="payment-logos">
              <span class="pay-logo">üí≥</span>
              <span class="pay-logo">üè¶</span>
              <span class="pay-logo">üì±</span>
            </div>
            <p>Pay securely via <strong>Razorpay</strong> ‚Äî supports UPI, Credit/Debit Cards, Net Banking, Wallets & EMI. Your payment information is encrypted and never stored on our servers.</p>
            <div class="razorpay-badge">
              <span>üîí</span> Powered by Razorpay ¬∑ PCI DSS Compliant
            </div>
          </div>
        </div>

        <!-- PLACE ORDER BUTTON -->
        <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()">
          <span id="pobText">üîí Pay Securely ‚Äî ‚Çπ5,999</span>
        </button>
        <p class="checkout-note">By placing your order you agree to our Terms of Use and Privacy Policy. Free shipping. 30-day returns.</p>
      </div>

      <!-- RIGHT: ORDER SUMMARY -->
      <div class="checkout-right">
        <div class="order-summary-card">
          <h3 class="os-title">Order Summary</h3>

          <div class="os-product">
            <div class="os-img">
              <img src="../images/product-main.jpeg" alt="Sippy" />
            </div>
            <div class="os-details">
              <div class="os-name">Sippy Smart Portable Kettle</div>
              <div class="os-variant">Cream / Ivory ¬∑ 300mL</div>
              <div class="os-qty">Qty: 1</div>
            </div>
            <div class="os-item-price">‚Çπ5,999</div>
          </div>

          <div class="divider"></div>

          <div class="os-line"><span>Subtotal</span><span>‚Çπ5,999</span></div>
          <div class="os-line"><span>Shipping</span><span class="free-tag">FREE</span></div>
          <div class="os-line"><span>Taxes</span><span>Included</span></div>
          <div class="divider"></div>
          <div class="os-total"><span>Total</span><span>‚Çπ5,999</span></div>

          <div class="os-trust">
            <div class="os-trust-item"><span>‚úÖ</span> Secure Checkout</div>
            <div class="os-trust-item"><span>üöö</span> Free Delivery All India</div>
            <div class="os-trust-item"><span>‚Ü©Ô∏è</span> 30-Day Easy Returns</div>
            <div class="os-trust-item"><span>‚≠ê</span> 5-Star Rated</div>
          </div>

          <div class="os-contact">
            <p>Need help? <a href="contact.html">Contact us</a> or</p>
            <a href="https://wa.me/918985656181" target="_blank" class="wa-btn">üí¨ WhatsApp Us</a>
          </div>
        </div>

        <!-- WHAT HAPPENS NEXT -->
        <div class="next-steps-card mt-24">
          <h4>What Happens Next?</h4>
          <div class="next-step"><div class="ns-num">1</div><div><strong>Order Confirmed</strong><p>You'll get an email confirmation immediately after payment.</p></div></div>
          <div class="next-step"><div class="ns-num">2</div><div><strong>Packed & Dispatched</strong><p>We pack and ship your order within 1‚Äì2 business days.</p></div></div>
          <div class="next-step"><div class="ns-num">3</div><div><strong>Delivered to You</strong><p>Delivery in 4‚Äì7 working days across India.</p></div></div>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- SUCCESS MODAL -->
<div class="success-modal" id="successModal" style="display:none;">
  <div class="sm-backdrop" onclick=""></div>
  <div class="sm-box">
    <div class="sm-icon">üéâ</div>
    <h2>Order Placed!</h2>
    <p>Thank you! Your Sippy is on its way. We've sent an order confirmation to your email.</p>
    <div class="sm-order-id" id="smOrderId"></div>
    <div class="sm-details" id="smDetails"></div>
    <a href="../index.html" class="btn btn-gold btn-lg" style="width:100%;justify-content:center;margin-top:24px;">Back to Home ‚Üí</a>
    <p style="font-size:12px;color:var(--muted);margin-top:12px;text-align:center;">Questions? <a href="contact.html" style="color:var(--gold);">Contact us</a> or WhatsApp +91 8985656181</p>
  </div>
</div>

<script src="../js/common.js"></script>
<script>
/* ============================================================
   RAZORPAY CHECKOUT
   ============================================================
   IMPORTANT SETUP STEPS:
   1. Create a Razorpay account at https://razorpay.com
   2. Get your Key ID from Razorpay Dashboard ‚Üí Settings ‚Üí API Keys
   3. Replace 'YOUR_RAZORPAY_KEY_ID' below with your actual Key ID
   4. For production: Create orders server-side via Razorpay API
      (see SETUP-GUIDE.txt for details)
   ============================================================ */

const RAZORPAY_KEY_ID = 'YOUR_RAZORPAY_KEY_ID'; // ‚Üê Replace this

function validateForm() {
  const required = {
    firstName: 'First Name',
    lastName: 'Last Name',
    email: 'Email Address',
    phone: 'Mobile Number',
    address1: 'House/Flat Address',
    address2: 'Street/Area',
    city: 'City',
    state: 'State',
    pincode: 'PIN Code'
  };
  for (const [id, label] of Object.entries(required)) {
    const el = document.getElementById(id);
    if (!el.value.trim()) {
      el.focus();
      el.style.borderColor = 'var(--red)';
      setTimeout(() => el.style.borderColor = '', 2500);
      showToast(`Please fill in: ${label}`, 'error');
      return false;
    }
  }
  const email = document.getElementById('email').value;
  const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRx.test(email)) {
    showToast('Please enter a valid email address', 'error');
    document.getElementById('email').focus();
    return false;
  }
  const phone = document.getElementById('phone').value.replace(/\D/g,'');
  if (phone.length < 10) {
    showToast('Please enter a valid 10-digit mobile number', 'error');
    document.getElementById('phone').focus();
    return false;
  }
  const pin = document.getElementById('pincode').value.replace(/\D/g,'');
  if (pin.length !== 6) {
    showToast('Please enter a valid 6-digit PIN code', 'error');
    document.getElementById('pincode').focus();
    return false;
  }
  return true;
}

function getFormData() {
  return {
    name: `${document.getElementById('firstName').value.trim()} ${document.getElementById('lastName').value.trim()}`,
    email: document.getElementById('email').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    address: `${document.getElementById('address1').value.trim()}, ${document.getElementById('address2').value.trim()}`,
    city: document.getElementById('city').value.trim(),
    state: document.getElementById('state').value,
    pincode: document.getElementById('pincode').value.trim(),
    landmark: document.getElementById('landmark').value.trim(),
    notes: document.getElementById('notes').value.trim()
  };
}

function placeOrder() {
  if (!validateForm()) return;

  const btn = document.getElementById('placeOrderBtn');
  const btnText = document.getElementById('pobText');
  btn.disabled = true;
  btnText.textContent = '‚è≥ Opening Razorpay...';

  const data = getFormData();

  /* ============================================================
     Razorpay Payment Options
     Amount is in PAISE (‚Çπ5,999 = 599900 paise)
     ============================================================ */
  const options = {
    key: RAZORPAY_KEY_ID,
    amount: 599900,              // ‚Çπ5,999 in paise
    currency: 'INR',
    name: 'Sippy',
    description: 'Sippy Smart Portable Kettle',
    image: '../images/sippy-logo.png',
    // order_id: 'order_xxx',   // Add server-generated order_id in production

    prefill: {
      name: data.name,
      email: data.email,
      contact: data.phone
    },

    notes: {
      address: `${data.address}, ${data.city}, ${data.state} - ${data.pincode}`,
      landmark: data.landmark,
      order_notes: data.notes
    },

    theme: {
      color: '#C9923A'   // Sippy gold
    },

    handler: function(response) {
      // Payment successful ‚Äî response contains:
      // response.razorpay_payment_id
      // response.razorpay_order_id (if order_id was set)
      // response.razorpay_signature (for server-side verification)
      onPaymentSuccess(response, data);
    },

    modal: {
      ondismiss: function() {
        btn.disabled = false;
        btnText.textContent = 'üîí Pay Securely ‚Äî ‚Çπ5,999';
        showToast('Payment cancelled. Your details are saved ‚Äî try again!', 'error');
      }
    }
  };

  try {
    const rzp = new Razorpay(options);
    rzp.on('payment.failed', function(response) {
      btn.disabled = false;
      btnText.textContent = 'üîí Pay Securely ‚Äî ‚Çπ5,999';
      showToast('Payment failed: ' + (response.error.description || 'Please try again'), 'error');
      console.error('Razorpay error:', response.error);
    });
    rzp.open();
  } catch(e) {
    btn.disabled = false;
    btnText.textContent = 'üîí Pay Securely ‚Äî ‚Çπ5,999';
    showToast('Could not open payment. Please check your Razorpay Key ID in js/checkout-config or contact support.', 'error');
    console.error('Razorpay init error:', e);
  }
}

async function onPaymentSuccess(razorpayResponse, data) {
  const btnText = document.getElementById('pobText');
  btnText.textContent = '‚úÖ Processing...';

  const orderId = razorpayResponse.razorpay_payment_id || ('ORD-' + Date.now());
  const orderDate = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', dateStyle:'medium', timeStyle:'short' });

  // Show success modal
  document.getElementById('smOrderId').textContent = `Payment ID: ${orderId}`;
  document.getElementById('smDetails').innerHTML = `
    <strong>${data.name}</strong><br/>
    ${data.address}, ${data.city}, ${data.state} ‚Äì ${data.pincode}<br/>
    ${data.phone} ¬∑ ${data.email}
  `;
  document.getElementById('successModal').style.display = 'flex';

  // Send emails via EmailJS
  try {
    await sendOrderEmails(data, orderId, orderDate);
  } catch(e) {
    console.warn('Email sending failed (order still successful):', e);
  }
}

async function sendOrderEmails(data, orderId, orderDate) {
  // Check EmailJS is configured
  if (!window.EMAILJS_CONFIGURED) {
    console.warn('EmailJS not configured ‚Äî skipping email. Open setup-emailjs.html for instructions.');
    return;
  }
  if (typeof emailjs === 'undefined') {
    console.warn('EmailJS SDK not loaded yet ‚Äî skipping email.');
    return;
  }

  const fullAddress = data.address + ', ' + data.city + ', ' + data.state + ' - ' + data.pincode + (data.landmark ? ' (Near: ' + data.landmark + ')' : '');

  // Email to store owner
  await emailjs.send(
    window.EMAILJS_SERVICE_ID,
    window.EMAILJS_ORDER_TEMPLATE,
    {
      to_email: 'smartkettlestore@gmail.com',
      subject: `üõí New Sippy Order ‚Äî ${data.name} ‚Äî ${orderId}`,
      message: `
NEW ORDER RECEIVED
==================
Order ID   : ${orderId}
Date       : ${orderDate}

CUSTOMER
--------
Name       : ${data.name}
Email      : ${data.email}
Phone      : ${data.phone}

DELIVERY ADDRESS
----------------
${fullAddress}
${data.notes ? 'Notes: ' + data.notes : ''}

ORDER DETAILS
-------------
Product    : Sippy Smart Portable Kettle
Qty        : 1
Amount     : ‚Çπ5,999 (Paid via Razorpay)
Payment ID : ${orderId}

Please dispatch within 1‚Äì2 business days.
      `
    }
  );

  // Confirmation email to customer
  await emailjs.send(
    window.EMAILJS_SERVICE_ID,
    window.EMAILJS_CONFIRM_TEMPLATE,
    {
      to_email: data.email,
      to_name: data.name,
      subject: `Your Sippy Order is Confirmed! üéâ [${orderId}]`,
      message: `
Hi ${data.name},

Your order for Sippy has been confirmed and payment received!

ORDER DETAILS
-------------
Product    : Sippy Smart Portable Kettle
Amount Paid: ‚Çπ5,999
Payment ID : ${orderId}
Date       : ${orderDate}

DELIVERY TO
-----------
${fullAddress}

WHAT'S NEXT?
------------
‚Ä¢ We'll pack and ship your order within 1‚Äì2 business days
‚Ä¢ Delivery in 4‚Äì7 working days across India
‚Ä¢ You'll receive a tracking update via SMS/email

NEED HELP?
----------
üìß smartkettlestore@gmail.com
üìû +91 8985656181
üí¨ WhatsApp: https://wa.me/918985656181

Thank you for choosing Sippy! ‚òï
Stay warm,
Team Sippy
      `
    }
  );
}
</script>
</body>
</html>
